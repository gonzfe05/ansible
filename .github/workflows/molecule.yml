---
name: molecule

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "playbooks/roles/**"

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tools
        run: |
          pip install ansible-core molecule "molecule-plugins[docker]"

      - name: Test apt_installs role
        run: |
          cd playbooks/roles/apt_installs
          
          # Create simple working molecule config
          cat > molecule/default/molecule.yml << 'EOF'
          ---
          driver:
            name: docker
          platforms:
            - name: instance
              image: ubuntu:22.04
              command: sleep 60
          provisioner:
            name: ansible
          EOF
          
          # Create simple converge playbook
          cat > molecule/default/converge.yml << 'EOF'
          ---
          - hosts: all
            become: true
            vars:
              apt_update_cache: true
              apt_cache_valid_time: 3600
              apt_installs_custom: ["git"]
              apt_ppa_custom: []
            tasks:
              - name: Update apt cache
                apt:
                  update_cache: yes
              - name: Include role
                include_role:
                  name: apt_installs
          EOF
          
          # Run test
          echo "Starting molecule test..."
          molecule create
          echo "Container created successfully"
          molecule converge
          echo "Converge completed successfully"
          molecule destroy
          echo "Test completed successfully!"